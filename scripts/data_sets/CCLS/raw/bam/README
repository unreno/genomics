

Adding read groups to bams and replacing the originals.



nohup ./validate.bash > validate.1.out 2>&1 &

nohup ./validate.bash > validate.2.out 2>&1 &

nohup ./validate.bash > validate.3.out 2>&1 &

nohup ./validate.bash > validate.4.out 2>&1 &

nohup ./add_read_group.bash > add_read_group.out 2>&1 &

nohup ./index.bash > index.out 2>&1 &


nohup samtools view -h -o 439338.recaled.sam 439338.recaled.bam &
nohup samtools view -h -o 439338.recaled.2.bam 439338.recaled.sam &


Could probably add ...
--IGNORE MATE_NOT_FOUND
as every bam has many of these





gatk AddOrReplaceReadGroups --INPUT 439338.recaled.bam --OUTPUT 439338.tumor.bam --RGLB unknownLB --RGPL unknownPL --RGPU unknownPU --RGSM 439338.tumor

htsjdk.samtools.SAMFormatException: SAM validation error: ERROR: Record 1049197317, Read name E00521:51:h222cccxy:5:1101:18040:72473, bin field of BAM record does not equal value computed based on alignment start and end, and length of sequence to which read is aligned
  at htsjdk.samtools.SAMUtils.processValidationErrors(SAMUtils.java:454)
  at htsjdk.samtools.BAMFileReader$BAMFileIterator.advance(BAMFileReader.java:812)
  at htsjdk.samtools.BAMFileReader$BAMFileIterator.next(BAMFileReader.java:797)
  at htsjdk.samtools.BAMFileReader$BAMFileIterator.next(BAMFileReader.java:765)
  at htsjdk.samtools.SamReader$AssertingIterator.next(SamReader.java:576)
  at htsjdk.samtools.SamReader$AssertingIterator.next(SamReader.java:548)
  at picard.sam.AddOrReplaceReadGroups.doWork(AddOrReplaceReadGroups.java:182)
  at picard.cmdline.CommandLineProgram.instanceMain(CommandLineProgram.java:282)
  at org.broadinstitute.hellbender.cmdline.PicardCommandLineProgramExecutor.instanceMain(PicardCommandLineProgramExecutor.java:25)
  at org.broadinstitute.hellbender.Main.runCommandLineProgram(Main.java:160)
  at org.broadinstitute.hellbender.Main.mainEntry(Main.java:203)
  at org.broadinstitute.hellbender.Main.main(Main.java:289)


Converting to SAM and then back to BAM seems to fix this error.



Similar error in ...

868614.recaled.bam

htsjdk.samtools.SAMFormatException: SAM validation error: ERROR: Record 311283192, Read name A00354:16:H37GGDSXX:1:2278:7627:30076, bin field of BAM record does not equal value computed based on alignment start and end, and length of sequence to which read is aligned


nohup samtools view -h -o 868614.recaled.sam 868614.recaled.bam &








----------------------------------------------------------------------

20181120 - These bam files are aligned locally
( still not sure if aligners use the quality in fastq )
Resort by name, extract fastq, align end-to-end, extract PROPER PAIR, use that in Strelka2 )

sudo mkdir redo
sudo chown jake redo
nohup samtools sort -n --threads 40 -o redo/GM_983899.bam GM_983899.recaled.bam &


nohup samtools sort -n --threads 40 -o redo/983899.bam 983899.recaled.bam &
keeps failing?
nohup samtools sort -n --threads 40 -m 512M -o redo/983899.bam 983899.recaled.bam &
keeps failing?

Got hung up sorting both
[jake@system76-server /raid/data/raw/CCLS/bam]$ touch test
touch: cannot touch 'test': Read-only file system







wget https://github.com/biod/sambamba/releases/download/v0.6.8/sambamba-0.6.8-linux-static.gz


nohup sambamba sort -n --nthreads 40 -m 60GB --show-progress -o redo/983899.bam 983899.recaled.bam &

Took about 12 hours.
Output grew quite a bit 337GB -> 450GB !!!
Perhaps set compression level?
Will try again. Sometime.

Running through samtools really compresses. ACTUALLY, STILL RUNNING 12 hours later
samtools view -o 983899.samtools_view.bam 983899.bam

samtools view does compress it. if running sambamba sort again, set the compression level
-r--r--r-- 1 jake 450701614138 Nov 26 22:13 983899.bam
-rw-rw-r-- 1 jake 322638049280 Nov 27 18:18 983899.samtools_view.bam
-r--r--r-- 1 jake 249764383502 Nov 26 23:48 GM_983899.bam

nohup sambamba sort --uncompressed-chunks --sort-by-name  --compression-level=9 --nthreads 40 -m 50GB --show-progress -o redo/GM_983899.bam GM_983899.recaled.bam > redo/GM_983899.sambamba.out 2> redo/GM_983899.sambamba.err &

With compression 9, this is almost exactly the same size as the samtools sorted version.



cd redo
nohup samtools fastq --threads 19 -0 GM_983899.0.fastq.gz -1 GM_983899.1.fastq.gz -2 GM_983899.2.fastq.gz GM_983899.bam &
nohup samtools fastq --threads 19 -0 983899.0.fastq.gz -1 983899.1.fastq.gz -2 983899.2.fastq.gz 983899.bam &


nohup zcat 983899.1.fastq.gz | wc -l > 983899.1.fastq.gz.count &
nohup zcat 983899.2.fastq.gz | wc -l > 983899.2.fastq.gz.count &
nohup zcat GM_983899.1.fastq.gz | wc -l > GM_983899.1.fastq.gz.count &
nohup zcat GM_983899.2.fastq.gz | wc -l > GM_983899.2.fastq.gz.count &


The counts don't match!
-rw-rw-r-- 1 jake           11 Nov 27 15:05 GM_983899.1.fastq.gz.count
1579662820
-rw-rw-r-- 1 jake           11 Nov 27 14:49 GM_983899.2.fastq.gz.count
1580417276

Such a pain. Guessing that not all reads are paired. Trying again with the PAIRED flag.

nohup samtools fastq -f 1 --threads 19 -0 GM_983899.P.0.fastq.gz -1 GM_983899.P.1.fastq.gz -2 GM_983899.P.2.fastq.gz GM_983899.bam &
nohup samtools fastq -f 1 --threads 19 -0 983899.P.0.fastq.gz -1 983899.P.1.fastq.gz -2 983899.P.2.fastq.gz 983899.bam &



more counts

nohup samtools view -c -F 1 GM_983899.bam > GM_983899.bam.F1.count &
nohup samtools view -c -f 1 GM_983899.bam > GM_983899.bam.f1.count &
nohup samtools view -c -f 65 GM_983899.bam > GM_983899.bam.f65.count &
nohup samtools view -c -f 129 GM_983899.bam > GM_983899.bam.f129.count &
nohup samtools view -c -f 256 GM_983899.bam > GM_983899.bam.f256.count &
nohup samtools view -c -f 512 GM_983899.bam > GM_983899.bam.f512.count &
nohup samtools view -c -f 1024 GM_983899.bam > GM_983899.bam.f1024.count &
nohup samtools view -c -F 1 983899.bam > 983899.bam.F1.count &
nohup samtools view -c -f 1 983899.bam > 983899.bam.f1.count &
nohup samtools view -c -f 65 983899.bam > 983899.bam.f65.count &
nohup samtools view -c -f 129 983899.bam > 983899.bam.f129.count &
nohup samtools view -c -f 256 983899.bam > 983899.bam.f256.count &
nohup samtools view -c -f 512 983899.bam > 983899.bam.f512.count &
nohup samtools view -c -f 1024 983899.bam > 983899.bam.f1024.count &

==> 983899.bam.f1024.count <==
0

==> 983899.bam.f129.count <==
687471866

==> 983899.bam.f1.count <==
1374058911

==> 983899.bam.F1.count <==
0

==> 983899.bam.f256.count <==
8964764

==> 983899.bam.f512.count <==
0

==> 983899.bam.f65.count <==
686587045

==> GM_983899.1.fastq.gz.count <==
1579662820

==> GM_983899.2.fastq.gz.count <==
1580417276

==> GM_983899.bam.count <==
793788714

==> GM_983899.bam.f1024.count <==
0

==> GM_983899.bam.f129.count <==
397080437

==> GM_983899.bam.f1.count <==
793788714

==> GM_983899.bam.F1.count <==
0

==> GM_983899.bam.f256.count <==
3768690

==> GM_983899.bam.f512.count <==
0

==> GM_983899.bam.f65.count <==
396708277

==> GM_983899.P.1.fastq.gz.count <==
1260951945

==> GM_983899.P.2.fastq.gz.count <==
1261562193


WTF

Flags:
	0x1	PAIRED        .. paired-end (or multiple-segment) sequencing technology
	0x2	PROPER_PAIR   .. each segment properly aligned according to the aligner
	0x4	UNMAP         .. segment unmapped
	0x8	MUNMAP        .. next segment in the template unmapped
	0x10	REVERSE       .. SEQ is reverse complemented
	0x20	MREVERSE      .. SEQ of the next segment in the template is reversed
	0x40	READ1         .. the first segment in the template
	0x80	READ2         .. the last segment in the template
	0x100	SECONDARY     .. secondary alignment
	0x200	QCFAIL        .. not passing quality controls
	0x400	DUP           .. PCR or optical duplicate
	0x800	SUPPLEMENTARY .. supplementary alignment

  -f INT   only include reads with all  of the FLAGs in INT present [0]
  -F INT   only include reads with none of the FLAGS in INT present [0]
  -G INT   only EXCLUDE reads with all  of the FLAGs in INT present [0]







echo 2048+1024+512+256 | bc
3840

Paired and laned, but not special

nohup samtools view -@ 19 -c -f 65  -F 3840 983899.bam > 983899.bam.f065-F3840.count &
nohup samtools view -@ 19 -c -f 129 -F 3840 983899.bam > 983899.bam.f129-F3840.count &
nohup samtools view -@ 19 -c -f 65  -F 3840 GM_983899.bam > GM_983899.bam.f065-F3840.count &
nohup samtools view -@ 19 -c -f 129 -F 3840 GM_983899.bam > GM_983899.bam.f129-F3840.count &


This is just ridiculous

cat 983899.bam.f129-F3840.count 983899.bam.f065-F3840.count
682797234
682296913

cat GM_983899.bam.f129-F3840.count GM_983899.bam.f065-F3840.count
395104319
394915705



I'm gonna just have to get the raw FASTQ data again.
Or find my old script.

samtools_bam_to_paired_fastq.gawk, samtools_bam_to_paired_fastq.bash



--------------------------------------------------

Starting over?

sambamba sort

    not (unmapped or mate_is_unmapped) and first_of_pair
paired
proper_pair
unmapped
mate_is_unmapped
reverse_strand
mate_is_reverse_strand
first_of_pair
second_of_pair
secondary_alignment
failed_quality_control
duplicate
supplementary
chimeric

-F "paired and first_of_pair and not ( secondary_alignment or failed_quality_control or duplicate or supplementary)"
-F "paired and second_of_pair and not ( secondary_alignment or failed_quality_control or duplicate or supplementary)"

Next time.

Only need the fastq files so once the following is done, if it works, remove these bams.


nohup samtools view -f 1 -F 3840 983899.bam | gawk -v base=983899 -f sam_to_paired_fastq.gawk > 983899.sam_to_paired_fastq.gawk.out 2> 983899.sam_to_paired_fastq.gawk.err &

nohup samtools view -f 1 -F 3840 GM_983899.bam | gawk -v base=GM_983899 -f sam_to_paired_fastq.gawk > GM_983899.sam_to_paired_fastq.gawk.out 2> GM_983899.sam_to_paired_fastq.gawk.err &

That tooks 12-16 hours!

chmod a-w *983899.?.fastq

nohup wc -l 983899.1.fastq > 983899.1.fastq.count &
nohup wc -l 983899.2.fastq > 983899.2.fastq.count &
nohup wc -l GM_983899.1.fastq > GM_983899.1.fastq.count &
nohup wc -l GM_983899.2.fastq > GM_983899.2.fastq.count &

cat *.fastq.count
2728946344 983899.1.fastq
2728946344 983899.2.fastq
1579529356 GM_983899.1.fastq
1579529356 GM_983899.2.fastq

chmod a-w *983899.?.fastq.count

Whew!!!!



nohup gzip --keep --best 983899.1.fastq > 983899.1.fastq.gz.out 2> 983899.1.fastq.gz.err &
nohup gzip --keep --best 983899.2.fastq > 983899.2.fastq.gz.out 2> 983899.2.fastq.gz.err &
nohup gzip --keep --best GM_983899.1.fastq > GM_983899.1.fastq.gz.out 2> GM_983899.1.fastq.gz.err &
nohup gzip --keep --best GM_983899.2.fastq > GM_983899.2.fastq.gz.out 2> GM_983899.2.fastq.gz.err &

[5]   Exit 1                  nohup gzip --keep --best 983899.1.fastq > 983899.1.fastq.gz.out 2> 983899.1.fastq.gz.err
[6]   Exit 1                  nohup gzip --keep --best 983899.2.fastq > 983899.2.fastq.gz.out 2> 983899.2.fastq.gz.err
[7]-  Exit 1                  nohup gzip --keep --best GM_983899.1.fastq > GM_983899.1.fastq.gz.out 2> GM_983899.1.fastq.gz.err
[8]+  Exit 1                  nohup gzip --keep --best GM_983899.2.fastq > GM_983899.2.fastq.gz.out 2> GM_983899.2.fastq.gz.err

???

dmesg

[131343.193499] EXT4-fs error (device sda1): ext4_validate_block_bitmap:391: comm kworker/u82:0: bg 212156: bad block bitmap checksum
[131343.193779] Aborting journal on device sda1-8.
[131343.193912] EXT4-fs (sda1): Remounting filesystem read-only
[131343.194014] EXT4-fs error (device sda1) in ext4_writepages:2897: IO failure


\rm 983899.bam GM_983899.bam

Hope this doesn't happen again because it looks like gzipping is going to take about 20 hours.



nohup zcat 983899.1.fastq.gz | wc -l > 983899.1.fastq.gz.count &
nohup zcat 983899.2.fastq.gz | wc -l > 983899.2.fastq.gz.count &
nohup zcat GM_983899.1.fastq.gz | wc -l > GM_983899.1.fastq.gz.count &
nohup zcat GM_983899.2.fastq.gz | wc -l > GM_983899.2.fastq.gz.count &

cat *.fastq.gz.count
2728946344 983899.1.fastq
2728946344
2728946344 983899.2.fastq
2728946344
1579529356 GM_983899.1.fastq
1579529356
1579529356 GM_983899.2.fastq
1579529356


chmod a-w *983899.?.fastq.gz.count

\rm *983899.?.fastq


Add a read group next time ...
--rg-id 1 --rg SM:983899 --rg LB:unknownLB --rg PL:unknownPL --rg PU:unknownPU


nohup bowtie2 --rg-id 1 --rg SM:GM_983899 --rg LB:unknownLB --rg PL:unknownPL --rg PU:unknownPU --xeq -x hg38_no_alts -1 GM_983899.1.fastq.gz -2 GM_983899.2.fastq.gz --very-sensitive --threads 20 | samtools view -o GM_983899.name.hg38_no_alts.bam - > GM_983899.bowtie2.out 2> GM_983899.bowtie2.err &
nohup bowtie2 --rg-id 1 --rg SM:983899 --rg LB:unknownLB --rg PL:unknownPL --rg PU:unknownPU --xeq -x hg38_no_alts -1 983899.1.fastq.gz -2 983899.2.fastq.gz --very-sensitive --threads 20 | samtools view -o 983899.name.hg38_no_alts.bam - > 983899.bowtie2.out 2> 983899.bowtie2.err &


This is gonna take about 24 hours
Crashed with no messages. Gonna go straight to sam and catch stdout and stderr.

nohup bowtie2 --xeq -x hg38_no_alts -1 GM_983899.1.fastq.gz -2 GM_983899.2.fastq.gz --very-sensitive --threads 20 -S GM_983899.name.hg38_no_alts.sam > GM_983899.bowtie2.out 2> GM_983899.bowtie2.err & 
nohup bowtie2 --xeq -x hg38_no_alts -1 983899.1.fastq.gz -2 983899.2.fastq.gz --very-sensitive --threads 20 -S 983899.name.hg38_no_alts.sam > 983899.bowtie2.out 2> 983899.bowtie2.err &







These will need sorted prior to being indexed.

Does bowtie2 or vcf calling use the initial read qualities, or can I save time and disk space using FASTA instead.


nohup samtools view -c GM_983899.name.hg38_no_alts.sam > GM_983899.name.hg38_no_alts.sam.count &
nohup samtools view -c 983899.name.hg38_no_alts.sam > 983899.name.hg38_no_alts.sam.count &

Counts should be half of the fastq line counts
cat *count
1364473172
789764678




NOTE: sambamba sort ONLY SORTs BAM files!

Trying gatk SortSam

nohup gatk SortSam --INPUT 983899.name.hg38_no_alts.sam --OUTPUT 983899.hg38_no_alts.bam --SORT_ORDER coordinate > 983899.name.hg38_no_alts.sam.gatk.SortSam.out >> 983899.name.hg38_no_alts.sam.gatk.SortSam.err &
nohup gatk SortSam --INPUT GM_983899.name.hg38_no_alts.sam --OUTPUT GM_983899.hg38_no_alts.bam --SORT_ORDER coordinate > GM_983899.name.hg38_no_alts.sam.gatk.SortSam.out >> GM_983899.name.hg38_no_alts.sam.gatk.SortSam.err &


Filesystem crashed AGAIN. Installed latest fsck and restarted.
GM_983899 completed. Retrying 983899.

rename 's/bam$/gatk.SortSam.bam/' *bam

nohup samtools view -c GM_983899.hg38_no_alts.gatk.SortSam.bam > GM_983899.hg38_no_alts.bam.gatk.SortSam.count &
nohup samtools view -c 983899.hg38_no_alts.gatk.SortSam.bam > 983899.hg38_no_alts.bam.gatk.SortSam.count &

#
#nohup samtools view -@ 19 -o GM_983899.name.hg38_no_alts.bam GM_983899.name.hg38_no_alts.sam > GM_983899.name.hg38_no_alts.bam.out 2> GM_983899.name.hg38_no_alts.bam.err &
#nohup samtools view -@ 19 -o 983899.name.hg38_no_alts.bam 983899.name.hg38_no_alts.sam > 983899.name.hg38_no_alts.bam.out 2> 983899.name.hg38_no_alts.bam.err &
#
#nohup sambamba sort --uncompressed-chunks --compression-level=9 --nthreads 40 -m 50GB --show-progress -o 983899.hg38_no_alts.bam 983899.name.hg38_no_alts.sam > 983899.sambamba_sort.hg38_no_alts.sam.out 2> 983899.sambamba_sort.hg38_no_alts.sam.err &
#nohup sambamba sort --uncompressed-chunks --compression-level=9 --nthreads 40 -m 50GB --show-progress -o GM_983899.hg38_no_alts.bam GM_983899.name.hg38_no_alts.bam > GM_983899.sambamba_sort.hg38_no_alts.sam.out 2> GM_983899.sambamba_sort.hg38_no_alts.sam.err &
#

nohup samtools view -c GM_983899.hg38_no_alts.bam > GM_983899.hg38_no_alts.bam.count &
nohup samtools view -c 983899.hg38_no_alts.bam > 983899.hg38_no_alts.bam.count &


ls -1 *count
983899.1.fastq.count
983899.1.fastq.gz.count
983899.2.fastq.count
983899.2.fastq.gz.count
983899.hg38_no_alts.bam.count
983899.name.hg38_no_alts.sam.count
GM_983899.1.fastq.count
GM_983899.1.fastq.gz.count
GM_983899.2.fastq.count
GM_983899.2.fastq.gz.count
GM_983899.hg38_no_alts.bam.count
GM_983899.name.hg38_no_alts.sam.count


cat *count
2728946344 983899.1.fastq
2728946344
2728946344 983899.2.fastq
2728946344
1364473172
1364473172
1579529356 GM_983899.1.fastq
1579529356
1579529356 GM_983899.2.fastq
1579529356
789764678
789764678

Perfect!





\rm *983899.name.hg38_no_alts.?am




nohup samtools index -@ 19 GM_983899.hg38_no_alts.bam > GM_983899.hg38_no_alts.bam.index.out 2> GM_983899.hg38_no_alts.bam.index.err &
nohup samtools index -@ 19 983899.hg38_no_alts.bam > 983899.hg38_no_alts.bam.index.out 2> 983899.hg38_no_alts.bam.index.err &

select only PROPER_PAIRs

nohup samtools view -f 2 --threads 19 -o GM_983899.hg38_no_alts.PP.bam GM_983899.hg38_no_alts.bam > GM_983899.hg38_no_alts.PP.bam.out 2> GM_983899.hg38_no_alts.PP.bam.err &
nohup samtools view -f 2 --threads 19 -o 983899.hg38_no_alts.PP.bam 983899.hg38_no_alts.bam > 983899.hg38_no_alts.PP.bam.out 2> 983899.hg38_no_alts.PP.bam.err &


nohup samtools view -@ 9 -c GM_983899.hg38_no_alts.PP.bam > GM_983899.hg38_no_alts.PP.bam.count &
nohup samtools view -@ 9 -c 983899.hg38_no_alts.PP.bam > 983899.hg38_no_alts.PP.bam.count &

nohup samtools index -@ 9 GM_983899.hg38_no_alts.PP.bam > GM_983899.hg38_no_alts.PP.bam.index.out 2> GM_983899.hg38_no_alts.PP.bam.index.err &
nohup samtools index -@ 9 983899.hg38_no_alts.PP.bam > 983899.hg38_no_alts.PP.bam.index.out 2> 983899.hg38_no_alts.PP.bam.index.err &



$ cat *count
2728946344 983899.1.fastq
2728946344 983899.1.fastq.gz
2728946344 983899.2.fastq
2728946344 983899.2.fastq.gz
1364473172 983899.hg38_no_alts.bam
1276940862 983899.hg38_no_alts.PP.bam
1364473172 983899.name.hg38_no_alts.sam
1579529356 GM_983899.1.fastq
1579529356 GM_983899.1.fastq.gz
1579529356 GM_983899.2.fastq
1579529356 GM_983899.2.fastq.gz
789764678 GM_983899.hg38_no_alts.bam
683474738 GM_983899.hg38_no_alts.PP.bam
789764678 GM_983899.name.hg38_no_alts.sam



cd /raid/refs/fasta
samtools faidx hg38_no_alts.fa
gatk CreateSequenceDictionary --REFERENCE hg38_no_alts.fa --OUTPUT hg38_no_alts.dict



Haplotype caller crashes with ...
java.lang.IllegalArgumentException: samples cannot be empty
Likely needs a read group. Stupied requirement.
It would be nice to figure out how to add this from the beginning.

bowtie2 has these options that should be used if using gatk
  --rg-id <text>     set read group id, reflected in @RG line and RG:Z: opt field
  --rg <text>        add <text> ("lab:value") to @RG line of SAM header.
                     Note: @RG line only printed when --rg-id is set.

@RG     ID:1    LB:unknownLB    PL:unknownPL    SM:983899       PU:unknownPU
--rg-id 1 --rg SM:983899 --rg LB:unknownLB --rg PL:unknownPL --rg PU:unknownPU

nohup gatk AddOrReplaceReadGroups --INPUT 983899.hg38_no_alts.bam --OUTPUT 983899.hg38_no_alts.RG.bam --RGLB unknownLB --RGPL unknownPL --RGPU unknownPU --RGSM 983899 > 983899.hg38_no_alts.RG.bam.out 2> 983899.hg38_no_alts.RG.bam.err &
nohup gatk AddOrReplaceReadGroups --INPUT GM_983899.hg38_no_alts.bam --OUTPUT GM_983899.hg38_no_alts.RG.bam --RGLB unknownLB --RGPL unknownPL --RGPU unknownPU --RGSM GM_983899 > GM_983899.hg38_no_alts.RG.bam.out 2> GM_983899.hg38_no_alts.RG.bam.err &
nohup gatk AddOrReplaceReadGroups --INPUT 983899.hg38_no_alts.PP.bam --OUTPUT 983899.hg38_no_alts.PP.RG.bam --RGLB unknownLB --RGPL unknownPL --RGPU unknownPU --RGSM 983899 > 983899.hg38_no_alts.PP.RG.bam.out 2> 983899.hg38_no_alts.PP.RG.bam.err &
nohup gatk AddOrReplaceReadGroups --INPUT GM_983899.hg38_no_alts.PP.bam --OUTPUT GM_983899.hg38_no_alts.PP.RG.bam --RGLB unknownLB --RGPL unknownPL --RGPU unknownPU --RGSM GM_983899 > GM_983899.hg38_no_alts.PP.RG.bam.out 2> GM_983899.hg38_no_alts.PP.RG.bam.err &

nohup samtools view -@ 9 -c GM_983899.hg38_no_alts.RG.bam > GM_983899.hg38_no_alts.RG.bam.count &
nohup samtools view -@ 9 -c 983899.hg38_no_alts.RG.bam > 983899.hg38_no_alts.RG.bam.count &
nohup samtools view -@ 9 -c GM_983899.hg38_no_alts.PP.RG.bam > GM_983899.hg38_no_alts.PP.RG.bam.count &
nohup samtools view -@ 9 -c 983899.hg38_no_alts.PP.RG.bam > 983899.hg38_no_alts.PP.RG.bam.count &

nohup samtools index -@ 9 GM_983899.hg38_no_alts.RG.bam > GM_983899.hg38_no_alts.RG.bam.index.out 2> GM_983899.hg38_no_alts.RG.bam.index.err &
nohup samtools index -@ 9 983899.hg38_no_alts.RG.bam > 983899.hg38_no_alts.RG.bam.index.out 2> 983899.hg38_no_alts.RG.bam.index.err &
nohup samtools index -@ 9 GM_983899.hg38_no_alts.PP.RG.bam > GM_983899.hg38_no_alts.PP.RG.bam.index.out 2> GM_983899.hg38_no_alts.PP.RG.bam.index.err &
nohup samtools index -@ 9 983899.hg38_no_alts.PP.RG.bam > 983899.hg38_no_alts.PP.RG.bam.index.out 2> 983899.hg38_no_alts.PP.RG.bam.index.err &


remove bam's without read group
ll *983899.hg38_no_alts.bam *983899.hg38_no_alts.PP.bam






Testing a jobqueue using parallel. Works, but perhaps not the best for this set up
( parallel won't start until there are as many jobs as there are slots! by default this is the number of cores (40 for us) although you can specify with -P option. )

true > jobqueue; tail -n+0 -f jobqueue | parallel --joblog parallel.log -P 1 &

echo "gatk HaplotypeCaller --input GM_983899.hg38_no_alts.RG.bam --output GM_983899.hg38_no_alts.RG.vcf.gz --reference /raid/refs/fasta/hg38_no_alts.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.vcf.gz > GM_983899.hg38_no_alts.RG.vcf.gz.out 2> GM_983899.hg38_no_alts.RG.vcf.gz.err" >> jobqueue

echo "gatk HaplotypeCaller --input 983899.hg38_no_alts.RG.bam --output 983899.hg38_no_alts.RG.vcf.gz --reference /raid/refs/fasta/hg38_no_alts.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.vcf.gz > 983899.hg38_no_alts.RG.vcf.gz.out 2> 983899.hg38_no_alts.RG.vcf.gz.err" >> jobqueue

echo "gatk HaplotypeCaller --input GM_983899.hg38_no_alts.PP.RG.bam --output GM_983899.hg38_no_alts.PP.RG.vcf.gz --reference /raid/refs/fasta/hg38_no_alts.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.vcf.gz > GM_983899.hg38_no_alts.PP.RG.vcf.gz.out 2> GM_983899.hg38_no_alts.PP.RG.vcf.gz.err" >> jobqueue

echo "gatk HaplotypeCaller --input 983899.hg38_no_alts.PP.RG.bam --output 983899.hg38_no_alts.PP.RG.vcf.gz --reference /raid/refs/fasta/hg38_no_alts.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.vcf.gz > 983899.hg38_no_alts.PP.RG.vcf.gz.out 2> 983899.hg38_no_alts.PP.RG.vcf.gz.err" >> jobqueue





nohup gatk HaplotypeCaller --input GM_983899.hg38_no_alts.RG.bam --output GM_983899.hg38_no_alts.RG.vcf.gz --reference /raid/refs/fasta/hg38_no_alts.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.vcf.gz > GM_983899.hg38_no_alts.RG.vcf.gz.out 2> GM_983899.hg38_no_alts.RG.vcf.gz.err &

nohup gatk HaplotypeCaller --input 983899.hg38_no_alts.RG.bam --output 983899.hg38_no_alts.RG.vcf.gz --reference /raid/refs/fasta/hg38_no_alts.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.vcf.gz > 983899.hg38_no_alts.RG.vcf.gz.out 2> 983899.hg38_no_alts.RG.vcf.gz.err &

nohup gatk HaplotypeCaller --input GM_983899.hg38_no_alts.PP.RG.bam --output GM_983899.hg38_no_alts.PP.RG.vcf.gz --reference /raid/refs/fasta/hg38_no_alts.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.vcf.gz > GM_983899.hg38_no_alts.PP.RG.vcf.gz.out 2> GM_983899.hg38_no_alts.PP.RG.vcf.gz.err &

nohup gatk HaplotypeCaller --input 983899.hg38_no_alts.PP.RG.bam --output 983899.hg38_no_alts.PP.RG.vcf.gz --reference /raid/refs/fasta/hg38_no_alts.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.vcf.gz > 983899.hg38_no_alts.PP.RG.vcf.gz.out 2> 983899.hg38_no_alts.PP.RG.vcf.gz.err &








----------------------------------------------------------------------
20181203 - OK - One more time

Strelka does not like CIGAR strings with = and X so no --xeq option to bowtie2

GATK tools seem to all need a valid read group. Easiest to add it here with bowtie2.

I put the following commands in a list and will run sequentially with parallel

nohup parallel --no-notice --joblog parallel.log -P 1 < rebuild_commands.txt &

Of course, as I'm just using 1 job slot, this could have been a simple script. Testing concept.

parallel seems to execute code based on where parallel was started. checking.



nohup bowtie2 --rg-id 1 --rg SM:GM_983899 --rg LB:unknownLB --rg PL:unknownPL --rg PU:unknownPU -x hg38_no_alts -1 GM_983899.1.fastq.gz -2 GM_983899.2.fastq.gz --very-sensitive --threads 20 | samtools view -o GM_983899.name.hg38_no_alts.bam - > GM_983899.bowtie2.out 2> GM_983899.bowtie2.err &
nohup bowtie2 --rg-id 1 --rg SM:983899 --rg LB:unknownLB --rg PL:unknownPL --rg PU:unknownPU -x hg38_no_alts -1 983899.1.fastq.gz -2 983899.2.fastq.gz --very-sensitive --threads 20 | samtools view -o 983899.name.hg38_no_alts.bam - > 983899.bowtie2.out 2> 983899.bowtie2.err &



nohup samtools view -c GM_983899.name.hg38_no_alts.bam > GM_983899.name.hg38_no_alts.bam.count &
nohup samtools view -c 983899.name.hg38_no_alts.bam > 983899.name.hg38_no_alts.bam.count &

Counts should be half of the fastq line counts
cat *count
1364473172
789764678


nohup sambamba sort --uncompressed-chunks --compression-level=9 --nthreads 40 -m 50GB --show-progress -o 983899.hg38_no_alts.bam 983899.name.hg38_no_alts.bam > 983899.sambamba_sort.hg38_no_alts.bam.out 2> 983899.sambamba_sort.hg38_no_alts.bam.err &

nohup sambamba sort --uncompressed-chunks --compression-level=9 --nthreads 40 -m 50GB --show-progress -o GM_983899.hg38_no_alts.bam GM_983899.name.hg38_no_alts.bam > GM_983899.sambamba_sort.hg38_no_alts.bam.out 2> GM_983899.sambamba_sort.hg38_no_alts.bam.err &


nohup samtools view -c GM_983899.hg38_no_alts.bam > GM_983899.hg38_no_alts.bam.count &
nohup samtools view -c 983899.hg38_no_alts.bam > 983899.hg38_no_alts.bam.count &


ls -1 *count


cat *count









Perfect!



\rm *983899.name.hg38_no_alts.?am

nohup samtools index -@ 19 GM_983899.hg38_no_alts.bam > GM_983899.hg38_no_alts.bam.index.out 2> GM_983899.hg38_no_alts.bam.index.err &
nohup samtools index -@ 19 983899.hg38_no_alts.bam > 983899.hg38_no_alts.bam.index.out 2> 983899.hg38_no_alts.bam.index.err &

select only PROPER_PAIRs

nohup samtools view -f 2 --threads 19 -o GM_983899.hg38_no_alts.PP.bam GM_983899.hg38_no_alts.bam > GM_983899.hg38_no_alts.PP.bam.out 2> GM_983899.hg38_no_alts.PP.bam.err &
nohup samtools view -f 2 --threads 19 -o 983899.hg38_no_alts.PP.bam 983899.hg38_no_alts.bam > 983899.hg38_no_alts.PP.bam.out 2> 983899.hg38_no_alts.PP.bam.err &


nohup samtools view -@ 9 -c GM_983899.hg38_no_alts.PP.bam > GM_983899.hg38_no_alts.PP.bam.count &
nohup samtools view -@ 9 -c 983899.hg38_no_alts.PP.bam > 983899.hg38_no_alts.PP.bam.count &

nohup samtools index -@ 9 GM_983899.hg38_no_alts.PP.bam > GM_983899.hg38_no_alts.PP.bam.index.out 2> GM_983899.hg38_no_alts.PP.bam.index.err &
nohup samtools index -@ 9 983899.hg38_no_alts.PP.bam > 983899.hg38_no_alts.PP.bam.index.out 2> 983899.hg38_no_alts.PP.bam.index.err &



$ cat *count
2728946344 983899.1.fastq
2728946344 983899.1.fastq.gz
2728946344 983899.2.fastq
2728946344 983899.2.fastq.gz
1364473172 983899.hg38_no_alts.bam
1276940862 983899.hg38_no_alts.PP.bam
1364473172 983899.name.hg38_no_alts.sam
1579529356 GM_983899.1.fastq
1579529356 GM_983899.1.fastq.gz
1579529356 GM_983899.2.fastq
1579529356 GM_983899.2.fastq.gz
789764678 GM_983899.hg38_no_alts.bam
683474738 GM_983899.hg38_no_alts.PP.bam
789764678 GM_983899.name.hg38_no_alts.sam







Rebuild new dbsnp to not have "chr" prefix


nohup gatk HaplotypeCaller --input GM_983899.hg38.num.bam --output GM_983899.hg38.num.vcf.gz --reference /raid/refs/fasta/hg38.num.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.vcf.gz > GM_983899.hg38.num.vcf.gz.out 2> GM_983899.hg38.num.vcf.gz.err &

nohup gatk HaplotypeCaller --input 983899.hg38.num.bam --output 983899.hg38.num.vcf.gz --reference /raid/refs/fasta/hg38.num.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.vcf.gz > 983899.hg38.num.vcf.gz.out 2> 983899.hg38.num.vcf.gz.err &

nohup gatk HaplotypeCaller --input GM_983899.hg38.num.PP.bam --output GM_983899.hg38.num.PP.vcf.gz --reference /raid/refs/fasta/hg38.num.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.vcf.gz > GM_983899.hg38.num.PP.vcf.gz.out 2> GM_983899.hg38.num.PP.vcf.gz.err &

nohup gatk HaplotypeCaller --input 983899.hg38.num.PP.bam --output 983899.hg38.num.PP.vcf.gz --reference /raid/refs/fasta/hg38.num.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.vcf.gz > 983899.hg38.num.PP.vcf.gz.out 2> 983899.hg38.num.PP.vcf.gz.err &


nohup samtools view -f 2 -o 983899.recaled.PP.bam 983899.recaled.bam &
nohup samtools view -f 2 -o GM_983899.recaled.PP.bam GM_983899.recaled.bam &




Awk Sum Squares Standard Deviation (stddev)

RUNNING samtools depth -a ../983899.recaled.bam | awk 'BEGIN{OFS="\t"}{ sum+=$3; sumsq+=($3)^2; print "Avg:",sum/NR,"Stddev:",sqrt((sumsq-sum^2/NR)/NR)}'

nohup samtools depth -a 983899.recaled.bam | awk 'BEGIN{OFS="\t"}{ sum+=$3; sumsq+=($3)^2}END{print "Avg:",sum/NR,"Stddev:",sqrt((sumsq-sum^2/NR)/NR)}' > 983899.recaled.bam.depth.txt &
nohup samtools depth -a GM_983899.recaled.bam | awk 'BEGIN{OFS="\t"}{ sum+=$3; sumsq+=($3)^2}END{print "Avg:",sum/NR,"Stddev:",sqrt((sumsq-sum^2/NR)/NR)}' > GM_983899.recaled.bam.depth.txt &



nohup samtools depth -a 983899.hg38.num.bam | awk 'BEGIN{OFS="\t"}{ sum+=$3; sumsq+=($3)^2}END{print "Avg:",sum/NR,"Stddev:",sqrt((sumsq-sum^2/NR)/NR)}' > 983899.hg38.num.bam.depth.txt &
nohup samtools depth -a 983899.hg38.num.PP.bam | awk 'BEGIN{OFS="\t"}{ sum+=$3; sumsq+=($3)^2}END{print "Avg:",sum/NR,"Stddev:",sqrt((sumsq-sum^2/NR)/NR)}' > 983899.hg38.num.PP.bam.depth.txt &
nohup samtools depth -a GM_983899.hg38.num.bam | awk 'BEGIN{OFS="\t"}{ sum+=$3; sumsq+=($3)^2}END{print "Avg:",sum/NR,"Stddev:",sqrt((sumsq-sum^2/NR)/NR)}' > GM_983899.hg38.num.bam.depth.txt &
nohup samtools depth -a GM_983899.hg38.num.PP.bam | awk 'BEGIN{OFS="\t"}{ sum+=$3; sumsq+=($3)^2}END{print "Avg:",sum/NR,"Stddev:",sqrt((sumsq-sum^2/NR)/NR)}' > GM_983899.hg38.num.PP.bam.depth.txt &



nohup samtools view -c 983899.recaled.bam > 983899.recaled.bam.count.txt &
nohup samtools view -c -F 4 983899.recaled.bam > 983899.recaled.bam.mapped.count.txt &
nohup samtools view -c -f 2 983899.recaled.bam > 983899.recaled.bam.proper_pair.count.txt &
nohup samtools view -c GM_983899.recaled.bam > GM_983899.recaled.bam.count.txt &
nohup samtools view -c -F 4 GM_983899.recaled.bam > GM_983899.recaled.bam.mapped.count.txt &
nohup samtools view -c -f 2 GM_983899.recaled.bam > GM_983899.recaled.bam.proper_pair.count.txt &

nohup samtools view -c 983899.hg38.num.bam > 983899.hg38.num.bam.count.txt &
nohup samtools view -c -F 4 983899.hg38.num.bam > 983899.hg38.num.bam.mapped.count.txt &
nohup samtools view -c -f 2 983899.hg38.num.bam > 983899.hg38.num.bam.proper_pair.count.txt &
nohup samtools view -c GM_983899.hg38.num.bam > GM_983899.hg38.num.bam.count.txt &
nohup samtools view -c -F 4 GM_983899.hg38.num.bam > GM_983899.hg38.num.bam.mapped.count.txt &
nohup samtools view -c -f 2 GM_983899.hg38.num.bam > GM_983899.hg38.num.bam.proper_pair.count.txt &


gatk HaplotypeCaller --input GM_983899.recaled.bam --output GM_983899.recaled.vcf.gz --reference /raid/refs/fasta/hg38.num.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.num.MT.vcf.gz > GM_983899.recaled.vcf.gz.out 2> GM_983899.recaled.vcf.gz.err &

gatk HaplotypeCaller --input 983899.recaled.bam --output 983899.recaled.vcf.gz --reference /raid/refs/fasta/hg38.num.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.num.MT.vcf.gz > 983899.recaled.vcf.gz.out 2> 983899.recaled.vcf.gz.err &


nohup samtools depth -a GM_983899.recaled.PP.bam | awk 'BEGIN{OFS="\t"}{ sum+=$3; sumsq+=($3)^2}END{print "Avg:",sum/NR,"Stddev:",sqrt((sumsq-sum^2/NR)/NR)}' > GM_983899.recaled.PP.bam.depth.txt &

nohup samtools index GM_983899.recaled.PP.bam &



nohup bcftools query -i 'TYPE="snp"' -f '-\n' GM_983899.hg38.num.PP.vcf.gz | wc -l > GM_983899.hg38.num.PP.vcf.snp.count.txt &
nohup bcftools query -i 'TYPE="indel"' -f '-\n' GM_983899.hg38.num.PP.vcf.gz | wc -l > GM_983899.hg38.num.PP.vcf.indel.count.txt &
nohup bcftools query -i 'TYPE="snp"' -f '-\n' GM_983899.hg38.num.vcf.gz | wc -l > GM_983899.hg38.num.vcf.snp.count.txt &
nohup bcftools query -i 'TYPE="indel"' -f '-\n' GM_983899.hg38.num.vcf.gz | wc -l > GM_983899.hg38.num.vcf.indel.count.txt &


nohup gatk HaplotypeCaller --input GM_983899.recaled.PP.bam --output GM_983899.recaled.PP.vcf.gz --reference /raid/refs/fasta/hg38.num.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.num.MT.vcf.gz > GM_983899.recaled.PP.vcf.gz.out 2> GM_983899.recaled.PP.vcf.gz.err &



nohup samtools index 983899.recaled.PP.bam &

nohup samtools depth -a 983899.recaled.PP.bam | awk 'BEGIN{OFS="\t"}{ sum+=$3; sumsq+=($3)^2}END{print "Avg:",sum/NR,"Stddev:",sqrt((sumsq-sum^2/NR)/NR)}' > 983899.recaled.PP.bam.depth.txt &
nohup gatk HaplotypeCaller --input 983899.recaled.PP.bam --output 983899.recaled.PP.vcf.gz --reference /raid/refs/fasta/hg38.num.fa --dbsnp /raid/refs/vcf/dbsnp_146.hg38.num.MT.vcf.gz > 983899.recaled.PP.vcf.gz.out 2> 983899.recaled.PP.vcf.gz.err &


------


ll {*983899.recaled*,redo/*983899.hg38.num*}bam
ll {*983899.recaled*,redo/*983899.hg38.num*}.bam.depth.txt
ll {*983899.recaled*,redo/*983899.hg38.num*}.bam.max.depth.txt
for f in *983899.recaled*bam redo/*983899.hg38.num*bam ; do
nohup samtools depth -a $f | awk 'BEGIN{OFS="\t";max=0;z=0}{if($3>max){max=$3};if($3==0){z+=1};sum+=$3;sumsq+=($3)^2}END{print "Zero Count:",z,"Max:",max,"Avg:",sum/NR,"Stddev:",sqrt((sumsq-sum^2/NR)/NR)}' > $f.max.depth.txt &
done

ll {*983899.recaled*,redo/*983899.hg38.num*}vcf.gz
ll {*983899.recaled*,redo/*983899.hg38.num*}vcf.gz.*.count.txt

nohup bcftools query -i 'TYPE="'${t}'"' -f '-\n' ${f} | wc -l > ${f}.${t}.count.txt &


for f in *983899.recaled*vcf.gz ; do
for f in ../vcf/*983899.output-HC.vcf.gz ; do
for f in redo/*983899.hg38.num*vcf.gz ; do
for f in GM_983899.recaled*vcf.gz ; do
for f in 983899.recaled*vcf.gz ; do
for f in 983899.recaled*vcf.gz ; do


for t in snps indels ; do
for f in ../vcf/*983899.output-HC.vcf.gz *983899.recaled*vcf.gz redo/*983899.hg38.num*vcf.gz ; do
bcftools view --no-header --types ${t} ${f} | wc -l > ${f}.${t}.count.txt &
done ; done


